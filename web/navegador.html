<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cámara</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            background-color: #55a7e0;
            overflow: hidden;
        }

        #webcam {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
            background: black;
        }
    </style>
</head>
<body>
    <video id="webcam" autoplay playsinline></video>

    <script>
        let model, webcam;

        async function init() {
            try {
                model = await tf.loadLayersModel("https://teachablemachine.withgoogle.com/models/NvgoH6k29/model.json");
                webcam = document.getElementById("webcam");
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                webcam.srcObject = stream;
                webcam.addEventListener("loadeddata", predict);
            } catch (error) {
                console.error("Error al cargar el modelo o la cámara:", error);
                if (window.chrome && window.chrome.webview) window.chrome.webview.postMessage("ERROR_CAMARA_O_MODELO");
            }
        }

        async function predict() {
            const classNames = ["Piedra", "Papel", "Tijeras"];
            while (true) {
                try {
                    const img = tf.browser.fromPixels(webcam).resizeNearestNeighbor([224, 224]).toFloat().div(tf.scalar(255)).expandDims();
                    const prediction = model.predict(img);
                    const probs = await prediction.data();
                    const maxIndex = probs.indexOf(Math.max(...probs));
                    if (window.chrome && window.chrome.webview) window.chrome.webview.postMessage(maxIndex.toString());
                } catch (e) {
                    console.error("Error durante la predicción:", e);
                    if (window.chrome && window.chrome.webview) window.chrome.webview.postMessage("ERROR_PREDICCION");
                }
                await new Promise(r => setTimeout(r, 300));
                await tf.nextFrame();
            }
        }

        init();
    </script>
</body>
</html>